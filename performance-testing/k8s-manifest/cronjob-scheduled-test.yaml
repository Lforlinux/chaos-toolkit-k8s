apiVersion: batch/v1
kind: CronJob
metadata:
  name: k6-scheduled-smoke-test
  namespace: performance-testing
  labels:
    app: k6-performance-test
    test-type: scheduled
spec:
  # Run smoke test every 6 hours
  schedule: "0 */6 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: k6-performance-test
            test-type: scheduled
        spec:
          restartPolicy: Never
          containers:
          - name: k6
            image: grafana/k6:0.50.0
            command: ["k6", "run"]
            args:
              - "--out"
              - "json=/tmp/results.json"
              - "--out"
              - "statsd=statsd-exporter.performance-testing.svc.cluster.local:9125"
              - "/scripts/k6-smoke-test.js"
            env:
            - name: TARGET_URL
              value: "http://frontend-external.online-boutique.svc.cluster.local"
            resources:
              requests:
                memory: "256Mi"
                cpu: "200m"
              limits:
                memory: "512Mi"
                cpu: "500m"
            volumeMounts:
            - name: test-scripts
              mountPath: /scripts
            - name: results
              mountPath: /tmp
          volumes:
          - name: test-scripts
            configMap:
              name: k6-test-scripts
          - name: results
            emptyDir: {}

