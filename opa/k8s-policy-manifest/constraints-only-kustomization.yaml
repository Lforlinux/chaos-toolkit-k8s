apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Kustomization for Constraints only (used by opa-constraints-app.yaml)
# ConstraintTemplates are deployed separately via opa-constrainttemplates-app.yaml

resources:
  # PreSync Hook: Wait for ConstraintTemplate CRDs before applying Constraints
  - pre-sync-wait-crds.yaml

  # Only include Constraints
  - constraint-online-boutique-nonroot-demo.yaml
  - constraint-online-boutique-resource-limits-demo.yaml
  - constraint-online-boutique-latest-tag-demo.yaml
  - constraint-online-boutique-readonly-fs-demo.yaml
  - constraint-online-boutique-privileged-demo.yaml
  - constraint-online-boutique-required-labels-demo.yaml

# Add sync wave annotations
patches:
  # Wave 1: Constraints
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sRequiredNonRoot
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sRequiredResources
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sDisallowLatestTag
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sRequiredReadonlyFS
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sDisallowPrivileged
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sRequiredLabels

# Common labels
labels:
  - pairs:
      app: opa-constraints
      managed-by: kustomize

