apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Note: No default namespace set - ConstraintTemplates and Constraints are cluster-scoped resources
# The namespace.yaml creates gatekeeper-system namespace explicitly

# ConstraintTemplates and Constraints (policy definitions and enforcement)
# Used by ArgoCD application: opa-policies

resources:
  # Note: namespace.yaml is excluded - Gatekeeper creates gatekeeper-system namespace during installation
  # If you need to create it manually, use: kubectl create namespace gatekeeper-system

  # PreSync Hook: Wait for ConstraintTemplate CRDs before applying Constraints
  # This runs in wave 0.5 (after ConstraintTemplates wave 0, before Constraints wave 1)
  - pre-sync-wait-crds.yaml

  # Security Policies - ConstraintTemplates (wave 0)
  # These create CRDs that Constraints will use
  - constrainttemplate-require-nonroot.yaml
  - constrainttemplate-require-resource-limits.yaml
  - constrainttemplate-disallow-latest-tag.yaml
  - constrainttemplate-require-readonly-fs.yaml
  - constrainttemplate-disallow-privileged.yaml
  - constrainttemplate-require-labels.yaml

  # Constraints (applied to online-boutique namespace in dryrun mode)
  - constraint-online-boutique-nonroot-demo.yaml
  - constraint-online-boutique-resource-limits-demo.yaml
  - constraint-online-boutique-latest-tag-demo.yaml
  - constraint-online-boutique-readonly-fs-demo.yaml
  - constraint-online-boutique-privileged-demo.yaml
  - constraint-online-boutique-required-labels-demo.yaml

# Note: constraint-online-boutique-nonroot.yaml (enforce mode) is excluded
# Use switch-enforcement-mode.sh to change modes

# Add sync wave annotations for ArgoCD ordering
# Wave 0: ConstraintTemplates (policy definitions) - Creates CRDs
# Wave 0.5: PreSync Hook waits for ConstraintTemplate CRDs to be established
# Wave 1: Constraints (policy enforcement) - Uses the CRDs
# This ensures ConstraintTemplate CRDs are created before Constraints try to use them
patches:
  # Wave 0: ConstraintTemplates (policy definitions)
  # These create CRDs that Constraints will use
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "0"
    target:
      kind: ConstraintTemplate
  # Wave 1: Constraints (policy enforcement)
  # These use the CRDs created by ConstraintTemplates
  # The PreSync hook ensures CRDs are ready before these are applied
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sRequiredNonRoot
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sRequiredResources
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sDisallowLatestTag
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sRequiredReadonlyFS
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sDisallowPrivileged
  - patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "1"
    target:
      kind: K8sRequiredLabels

# Common labels for all resources
labels:
  - pairs:
      app: opa-policies
      managed-by: kustomize

